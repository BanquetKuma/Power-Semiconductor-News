name: Tool Ingest

# Collect tools from Product Hunt, Hacker News, and GitHub
# OPTIMIZED: Uses parallel collection (60s -> 20s)

on:
  schedule:
    # Run at 23:00 UTC = 08:00 JST daily
    - cron: '0 23 * * *'

  workflow_dispatch:
    inputs:
      date:
        description: 'Target date (YYYY-MM-DD), leave empty for yesterday'
        required: false
        type: string
      dry_run:
        description: 'Dry run (do not commit changes)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

env:
  PYTHON_VERSION: '3.11'

jobs:
  ingest:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'  # OPTIMIZED: pip cache

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-ingest.txt

      - name: Run ingest
        env:
          PH_TOKEN: ${{ secrets.PH_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          LOG_LEVEL: INFO
        run: |
          DATE_ARG=""
          if [ -n "${{ github.event.inputs.date }}" ]; then
            DATE_ARG="--date ${{ github.event.inputs.date }}"
          fi

          DRY_RUN_ARG=""
          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            DRY_RUN_ARG="--dry-run"
          fi

          python scripts/ingest.py $DATE_ARG $DRY_RUN_ARG

      - name: Check for changes
        id: changes
        run: |
          git diff --quiet data/ || echo "changes=true" >> $GITHUB_OUTPUT

      - name: Commit and push
        if: steps.changes.outputs.changes == 'true' && github.event.inputs.dry_run != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Pull latest changes before committing
          git fetch origin main
          git reset --soft origin/main

          TODAY=$(date -u +"%Y-%m-%d")

          git add data/
          git commit -m "chore(data): daily ingest ${TODAY}"
          git push origin main

      - name: Summary
        run: |
          echo "## Ingest Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f data/index.json ]; then
            TOTAL=$(jq -r '.total_count' data/index.json)
            LATEST=$(jq -r '.latest_date' data/index.json)
            echo "- **Total tools**: ${TOTAL}" >> $GITHUB_STEP_SUMMARY
            echo "- **Latest date**: ${LATEST}" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Sources" >> $GITHUB_STEP_SUMMARY

          if [ -f data/index.json ]; then
            jq -r '.sources | to_entries | .[] | "- \(.key): \(.value)"' data/index.json >> $GITHUB_STEP_SUMMARY
          fi
